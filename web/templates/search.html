<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Stili aggiuntivi per la visualizzazione dei dettagli dei log */
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .warning pre {
            background-color: #fff9e6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .modal-content {
            max-width: 800px;
            width: 80%;
        }
        
        .log-details pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }

        .actions {
            margin-top: 10px;
            margin-bottom: 20px;
            text-align: right;
        }

        .btn-danger {
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger:hover {
            background-color: #c9302c;
        }

        .btn-danger:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>PramaIA LogService</h1>
        </div>
        <nav>
            <ul>
                <li><a href="/dashboard/" class="active">Ricerca</a></li>
                <!-- <li><a href="/dashboard/stats">Statistiche</a></li> -->
                <li><a href="/dashboard/logservice">LogService</a></li>
                <!-- <li><a href="/dashboard/settings">Impostazioni</a></li> -->
            </ul>
        </nav>
    </header>

    <main>
        <section class="search-section">
            <h2>Ricerca Log</h2>
            <div class="actions">
                <button id="reset-logs" class="btn-danger">Reset Log Non Archiviati</button>
                <button id="reset-all" class="btn-danger" style="margin-left:8px;">Reset Tutto (compresi archivi)</button>
            </div>
            <form class="search-form" action="/dashboard/" method="get">
                <div class="form-row">
                    <div class="form-group">
                        <label for="project">Progetto</label>
                        <select id="project" name="project">
                            <option value="">Tutti</option>
                            <option value="PramaIAServer" {% if project == 'PramaIAServer' %}selected{% endif %}>PramaIAServer</option>
                            <option value="PramaIA-PDK" {% if project == 'PramaIA-PDK' %}selected{% endif %}>PramaIA-PDK</option>
                            <option value="PramaIA-Agents" {% if project == 'PramaIA-Agents' %}selected{% endif %}>PramaIA-Agents</option>
                            <option value="PramaIA-Plugins" {% if project == 'PramaIA-Plugins' %}selected{% endif %}>PramaIA-Plugins</option>
                            <option value="other" {% if project == 'other' %}selected{% endif %}>Altro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="level">Livello</label>
                        <select id="level" name="level">
                            <option value="">Tutti</option>
                            <option value="debug" {% if level == 'debug' %}selected{% endif %}>Debug</option>
                            <option value="info" {% if level == 'info' %}selected{% endif %}>Info</option>
                            <option value="warning" {% if level == 'warning' %}selected{% endif %}>Warning</option>
                            <option value="error" {% if level == 'error' %}selected{% endif %}>Error</option>
                            <option value="critical" {% if level == 'critical' %}selected{% endif %}>Critical</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="module">Modulo</label>
                        <input type="text" id="module" name="module" value="{{ module or '' }}" placeholder="Nome del modulo">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="start_date">Data inizio</label>
                        <input type="datetime-local" id="start_date" name="start_date" value="{{ start_date or '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="end_date">Data fine</label>
                        <input type="datetime-local" id="end_date" name="end_date" value="{{ end_date or '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="limit">Limite risultati</label>
                        <input type="number" id="limit" name="limit" value="{{ limit }}" min="1" max="1000">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn primary">Cerca</button>
                    <button type="button" class="btn secondary" id="reset-filters">Reimposta</button>
                </div>
            </form>
        </section>

        <section class="results-section">
            <h2>Risultati</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Progetto</th>
                            <th>Livello</th>
                            <th>Modulo</th>
                            <th>Messaggio</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr class="log-level-{{ log.level }}">
                            <td>{{ log.timestamp }}</td>
                            <td>{{ log.project }}</td>
                            <td>{{ log.level }}</td>
                            <td>{{ log.module }}</td>
                            <td>{{ log.message }}</td>
                            <td>
                                <button class="btn small" onclick="showDetails('{{ log.id }}')">Dettagli</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="pagination">
                {% if offset > 0 %}
                <a href="?project={{ project or '' }}&level={{ level or '' }}&module={{ module or '' }}&start_date={{ start_date or '' }}&end_date={{ end_date or '' }}&limit={{ limit }}&offset={{ offset - limit if offset - limit >= 0 else 0 }}" class="btn">Precedente</a>
                {% endif %}
                
                {% if logs|length >= limit %}
                <a href="?project={{ project or '' }}&level={{ level or '' }}&module={{ module or '' }}&start_date={{ start_date or '' }}&end_date={{ end_date or '' }}&limit={{ limit }}&offset={{ offset + limit }}" class="btn">Successivo</a>
                {% endif %}
            </div>
        </section>
    </main>

    <div id="log-details-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Dettagli Log</h3>
            <div id="log-details-container">
                <!-- I dettagli del log verranno inseriti qui tramite JavaScript -->
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2023 PramaIA LogService</p>
    </footer>

    <script>
    // Funzione per mostrare i dettagli del log in un modal
        function showDetails(logId) {
            fetch(`/api/logs/${logId}`, {
                headers: {
                    'X-API-Key': 'pramaiaadmin_api_key_123456'  // Chiave API admin per accedere a tutti i log
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Errore ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(log => {
                    const container = document.getElementById('log-details-container');
                    
                    // Funzione per visualizzare meglio gli oggetti details/context
                    function formatJsonDisplay(obj) {
                        if (!obj) return '<em>Nessun dato</em>';
                        
                        // Controlla se l'oggetto è vuoto
                        if (Object.keys(obj).length === 0) {
                            return '<em>Oggetto vuoto</em>';
                        }
                        
                        // Controlla se ci sono campi "undefined"
                        let hasUndefinedValues = false;
                        for (const key in obj) {
                            if (obj[key] === undefined || obj[key] === 'undefined') {
                                hasUndefinedValues = true;
                                break;
                            }
                        }
                        
                        if (hasUndefinedValues) {
                            // Se ci sono valori undefined, mostra un messaggio di avviso
                            return `<div class="warning">
                                <p>Attenzione: questo oggetto contiene valori non definiti.</p>
                                <pre>${JSON.stringify(obj, (key, value) => 
                                    value === undefined ? "[valore non definito]" : value, 2)}</pre>
                            </div>`;
                        } else {
                            // Altrimenti, mostra normalmente
                            return `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
                        }
                    }
                    
                    container.innerHTML = `
                        <div class="log-details">
                            <p><strong>ID:</strong> ${log.id}</p>
                            <p><strong>Timestamp:</strong> ${log.timestamp}</p>
                            <p><strong>Progetto:</strong> ${log.project}</p>
                            <p><strong>Livello:</strong> ${log.level}</p>
                            <p><strong>Modulo:</strong> ${log.module}</p>
                            <p><strong>Messaggio:</strong> ${log.message}</p>
                            <div class="details-section">
                                <h4>Dettagli</h4>
                                ${formatJsonDisplay(log.details)}
                            </div>
                            <div class="context-section">
                                <h4>Contesto</h4>
                                ${formatJsonDisplay(log.context)}
                            </div>
                        </div>
                    `;
                    
                    // Mostra il modal
                    const modal = document.getElementById('log-details-modal');
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Errore nel recupero dei dettagli del log:', error);
                    alert('Errore nel recupero dei dettagli del log: ' + error.message);
                });
        }
        
        // Chiudi il modal quando l'utente clicca sulla X
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('log-details-modal').style.display = 'none';
        });
        
        // Chiudi il modal quando l'utente clicca fuori dal modal
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('log-details-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // Gestione del pulsante di reset dei log
        document.addEventListener('DOMContentLoaded', function() {
            const resetLogsButton = document.getElementById('reset-logs');
            const resetAllButton = document.getElementById('reset-all');
            const resetFiltersButton = document.getElementById('reset-filters');

            // Funzione per resettare i filtri e ricaricare la pagina senza parametri
            if (resetFiltersButton) {
                resetFiltersButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.querySelector('.search-form');
                    if (form) {
                        // Azzera tutti i campi del form
                        form.reset();
                        // Ricarica la pagina senza parametri di filtro
                        window.location.href = '/dashboard/';
                    }
                });
            }
            
            if (resetLogsButton) {
                resetLogsButton.addEventListener('click', async function() {
                    if (confirm('ATTENZIONE! Stai per eliminare tutti i log non ancora archiviati. Questa operazione è irreversibile. Vuoi continuare?')) {
                        resetLogsButton.disabled = true;
                        const originalText = resetLogsButton.textContent;
                        resetLogsButton.textContent = 'Reset in corso...';
                        
                        try {
                            // Chiamata all'API per resettare tutti i log non archiviati
                            const response = await fetch('/api/logs/cleanup/unarchived', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-API-Key': 'pramaiaadmin_api_key_123456' // Usa la chiave amministrativa
                                },
                                body: JSON.stringify({})
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Errore ${response.status}: ${response.statusText}`);
                            }
                            
                            const result = await response.json();
                            
                            alert(`Reset completato: ${result.deleted_count} log eliminati.`);
                            
                            // Ricarica la pagina per aggiornare la lista dei log
                            window.location.reload();
                            
                        } catch (error) {
                            console.error('Errore durante il reset dei log:', error);
                            alert('Errore durante il reset dei log: ' + error.message);
                            
                            resetLogsButton.disabled = false;
                            resetLogsButton.textContent = originalText;
                        }
                    }
                });
            }

            // Pulsante per resettare tutto (inclusi gli archivi)
            if (resetAllButton) {
                resetAllButton.addEventListener('click', async function() {
                    if (confirm('ATTENZIONE! Stai per eliminare TUTTI i log, compresi gli archivi. Questa operazione è irreversibile. Vuoi continuare?')) {
                        resetAllButton.disabled = true;
                        const originalText = resetAllButton.textContent;
                        resetAllButton.textContent = 'Reset globale in corso...';

                        try {
                            const response = await fetch('/api/logs/cleanup/all', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-API-Key': 'pramaiaadmin_api_key_123456'
                                },
                                body: JSON.stringify({})
                            });

                            if (!response.ok) {
                                throw new Error(`Errore ${response.status}: ${response.statusText}`);
                            }

                            const result = await response.json();
                            alert(`Reset completo: ${result.deleted_logs} log eliminati, ${result.deleted_compressed} riferimenti compressi rimossi, ${result.removed_archives} file archivio rimossi.`);
                            window.location.reload();
                        } catch (error) {
                            console.error('Errore durante il reset globale:', error);
                            alert('Errore durante il reset globale: ' + error.message);
                            resetAllButton.disabled = false;
                            resetAllButton.textContent = originalText;
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
